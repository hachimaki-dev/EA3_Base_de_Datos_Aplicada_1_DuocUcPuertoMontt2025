<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Workshop - Admin Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #0d1117;
            --bg-card: #161b22;
            --border-color: #30363d;
            --accent: #58a6ff;
            --text-primary: #c9d1d9;
            --text-muted: #8b949e;
            --code-bg: #0d1117;
            --input-bg: #0d1117;
            --module-bg: #21262d;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }

        .hacker-font {
            font-family: 'Fira Code', monospace;
        }

        .pokeball-bg {
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0.1) 100%);
        }

        .pokemon-sprite {
            image-rendering: pixelated;
        }

        /* Animations */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>

<body class="p-8">
    <div id="app" class="max-w-6xl mx-auto">

        <header class="mb-8 flex justify-between items-center border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold hacker-font text-yellow-400">üõ†Ô∏è ADMIN PLAYGROUND</h1>
                <p class="text-sm opacity-60">Sistema de Pruebas y Control de Estado</p>
            </div>
            <div class="text-right">
                <div class="text-xl font-bold">üí∞ {{ economy.pokeCoins }} Coins</div>
                <button @click="resetAll" class="text-xs text-red-400 hover:text-red-300 underline mt-1">RESET
                    EVERYTHING</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- LEFT COLUMN: POKEMON DISPLAY -->
            <div class="space-y-6">
                <div
                    class="bg-gray-800 rounded-xl p-8 border-2 border-gray-700 relative overflow-hidden min-h-[400px] flex flex-col items-center justify-center">

                    <!-- Egg State -->
                    <div v-if="!pokemonState.exists" class="text-center animate-float">
                        <div class="text-9xl mb-4">ü•ö</div>
                        <p class="text-xl font-bold opacity-70">Esperando Huevo...</p>
                    </div>

                    <!-- Pokemon State -->
                    <div v-else class="text-center relative w-full">
                        <div class="absolute top-0 right-0 bg-gray-900 px-3 py-1 rounded-full text-xs font-mono">
                            ID: #{{ pokemonState.species.id }}
                        </div>

                        <div class="relative w-48 h-48 mx-auto mb-4">
                            <img :src="pokemonState.species.animatedSprite || pokemonState.species.sprite"
                                class="w-full h-full object-contain pokemon-sprite animate-float filter drop-shadow-2xl">
                        </div>

                        <h2 class="text-3xl font-bold mb-1 text-white">
                            {{ pokemonState.species.name }}
                            <span v-if="pokemonState.species.isShiny" class="text-yellow-400 text-lg">‚ú®</span>
                        </h2>
                        <p class="text-sm opacity-60 mb-6">Lvl. {{ pokemonState.level }} ‚Ä¢ {{
                            pokemonState.species.types.join(' / ') }}</p>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 gap-4 text-left bg-gray-900 p-4 rounded-lg text-sm font-mono mb-6">
                            <div>HP: <span class="text-green-400">{{ pokemonState.stats.hp }}</span></div>
                            <div>ATK: <span class="text-red-400">{{ pokemonState.stats.attack }}</span></div>
                            <div>DEF: <span class="text-blue-400">{{ pokemonState.stats.defense }}</span></div>
                            <div>SPD: <span class="text-yellow-400">{{ pokemonState.stats.speed }}</span></div>
                            <div class="col-span-2 border-t border-gray-700 pt-2 mt-2">
                                XP: {{ pokemonState.xp }} / {{ pokemonState.level * 100 }}
                            </div>
                        </div>

                        <!-- Evolution Status -->
                        <div v-if="canEvolve" class="animate-bounce">
                            <button @click="evolvePokemon"
                                class="bg-yellow-400 text-black font-bold px-6 py-2 rounded-full shadow-lg hover:scale-105 transition-transform">
                                ‚ú® EVOLUCIONAR AHORA
                            </button>
                        </div>
                        <div v-else-if="pokemonState.species.evolutionChainUrl" class="text-xs opacity-50">
                            Evoluci√≥n no disponible a√∫n
                        </div>
                    </div>
                </div>

                <!-- Console Log -->
                <div
                    class="bg-black rounded-lg p-4 font-mono text-xs h-40 overflow-y-auto border border-gray-700 text-green-400">
                    <div v-for="(log, i) in logs" :key="i" class="mb-1">
                        <span class="opacity-50">[{{ log.time }}]</span> {{ log.msg }}
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: CONTROLS -->
            <div class="space-y-6">

                <!-- Section: Spawning -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="font-bold text-lg mb-4 text-purple-400">üß¨ GEN√âTICA & SPAWN</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="hatchPokemonEgg" class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">
                            üê£ Eclosionar Random
                        </button>
                        <button @click="forceShinyHatch"
                            class="bg-yellow-900 hover:bg-yellow-800 text-yellow-200 p-2 rounded text-sm">
                            ‚ú® Eclosionar Shiny
                        </button>
                        <div class="col-span-2 flex gap-2">
                            <input v-model="forceId" type="number" placeholder="ID (1-1000)"
                                class="bg-gray-900 border border-gray-600 rounded px-3 py-2 w-full text-sm">
                            <button @click="forceHatchId"
                                class="bg-purple-600 hover:bg-purple-500 px-4 rounded text-sm font-bold whitespace-nowrap">
                                Force ID
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section: Progression -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="font-bold text-lg mb-4 text-green-400">üìà PROGRESI√ìN</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="addXP(50)" class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">
                            +50 XP
                        </button>
                        <button @click="addXP(1000)" class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">
                            +1000 XP (Level Up)
                        </button>
                        <button @click="forceLevelUp"
                            class="bg-green-700 hover:bg-green-600 p-2 rounded text-sm font-bold">
                            ‚¨ÜÔ∏è Force Level Up
                        </button>
                        <button @click="checkEvolutionAvailability('evolution_stone')"
                            class="bg-blue-700 hover:bg-blue-600 p-2 rounded text-sm">
                            üíé Test Stone Evo
                        </button>
                    </div>
                </div>

                <!-- Section: Economy -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="font-bold text-lg mb-4 text-yellow-400">üí∞ ECONOM√çA</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="earnCoins(100)" class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-sm">
                            +100 Coins
                        </button>
                        <button @click="earnCoins(10000)"
                            class="bg-yellow-700 hover:bg-yellow-600 p-2 rounded text-sm font-bold">
                            +10,000 Coins
                        </button>
                    </div>
                </div>

                <!-- Section: Levels -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="font-bold text-lg mb-4 text-red-400">üîì NIVELES</h3>
                    <div class="flex flex-wrap gap-2">
                        <button @click="unlockAllLevels"
                            class="bg-red-900 hover:bg-red-800 text-red-100 px-4 py-2 rounded text-sm w-full">
                            üîì Desbloquear Todos los Niveles
                        </button>
                        <div class="text-xs opacity-50 mt-2 w-full">
                            Niveles completados: {{ completedLevels.length }}
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Evolution Animation Overlay -->
        <div v-if="showPokemonAnimation === 'evolution'"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-95">
            <div class="text-center">
                <div class="text-4xl font-bold mb-8 text-white animate-pulse">
                    ¬°Evolucionando!
                </div>
                <div class="relative w-64 h-64 mx-auto mb-8">
                    <img :src="pokemonAnimationData.oldSprite"
                        class="absolute inset-0 w-full h-full object-contain animate-ping opacity-50">
                    <img :src="pokemonAnimationData.newSprite"
                        class="absolute inset-0 w-full h-full object-contain animate-bounce z-10">
                </div>
                <div class="text-3xl font-bold text-yellow-400 mt-8">
                    {{ pokemonState.species.name }} -> {{ pokemonAnimationData.newName }}
                </div>
                <button @click="showPokemonAnimation = null"
                    class="mt-8 px-6 py-2 bg-white text-black rounded-full font-bold">Cerrar</button>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    logs: [],
                    forceId: '',

                    // State mirrored from main app
                    pokemonState: {
                        exists: false,
                        isEgg: true,
                        species: null,
                        level: 0,
                        xp: 0,
                        moves: [],
                        evolutionStage: 0,
                        stats: null,
                        nickname: null,
                        hatchedAt: null,
                        lastLevelUp: null,
                        energy: 100,
                        maxEnergy: 100
                    },
                    economy: {
                        pokeCoins: 0,
                        totalEarned: 0,
                        totalSpent: 0,
                        inventory: []
                    },
                    completedLevels: [],

                    // UI State
                    canEvolve: false,
                    evolutionTarget: null,
                    showPokemonAnimation: null,
                    pokemonAnimationData: null
                }
            },
            methods: {
                log(msg) {
                    const time = new Date().toLocaleTimeString();
                    this.logs.unshift({ time, msg });
                    if (this.logs.length > 50) this.logs.pop();
                },

                // ==========================================
                // CORE POKEMON LOGIC (Copied & Adapted)
                // ==========================================

                async fetchPokemonFromAPI(id, isShiny = false) {
                    try {
                        this.log(`Fetching Pokemon ID: ${id} (Shiny: ${isShiny})`);
                        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
                        const data = await response.json();

                        const speciesResponse = await fetch(data.species.url);
                        const speciesData = await speciesResponse.json();

                        const sprite = isShiny ? data.sprites.front_shiny : data.sprites.front_default;
                        const animatedSprite = isShiny
                            ? (data.sprites.versions?.['generation-v']?.['black-white']?.animated?.front_shiny || sprite)
                            : (data.sprites.versions?.['generation-v']?.['black-white']?.animated?.front_default || sprite);

                        return {
                            id: data.id,
                            name: data.name.charAt(0).toUpperCase() + data.name.slice(1),
                            sprite: sprite,
                            animatedSprite: animatedSprite,
                            isShiny: isShiny,
                            types: data.types.map(t => t.type.name),
                            evolutionChainUrl: speciesData.evolution_chain.url,
                            baseStats: {
                                hp: data.stats[0].base_stat,
                                attack: data.stats[1].base_stat,
                                defense: data.stats[2].base_stat,
                                speed: data.stats[5].base_stat
                            },
                            moves: data.moves.slice(0, 20).map(m => ({
                                name: m.move.name.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                                learnedAt: m.version_group_details[0]?.level_learned_at || 1
                            })).sort((a, b) => a.learnedAt - b.learnedAt)
                        };
                    } catch (error) {
                        this.log(`Error fetching Pokemon: ${error.message}`);
                        return null;
                    }
                },

                getRandomBasicPokemonId() {
                    const basicPokemon = [
                        1, 4, 7, 10, 13, 16, 19, 21, 23, 25, 27, 29, 32, 35, 37, 39, 41, 43, 46, 48, 50, 52, 54, 56, 58, 60, 63, 66, 69, 72, 74, 77, 79, 81, 84, 86, 88, 90, 92, 96, 98, 100, 102, 104, 109, 111, 116, 118, 120, 123, 129, 133, 147,
                        152, 155, 158, 161, 163, 165, 167, 170, 172, 175, 177, 179, 183, 187, 191, 194, 204, 209, 215, 216, 218, 220, 223, 228, 231, 236, 239, 246,
                        252, 255, 258, 261, 263, 265, 270, 273, 276, 278, 280, 283, 285, 287, 290, 293, 296, 299, 304, 307, 309, 316, 318, 320, 322, 325, 328, 331, 333, 339, 341, 343, 345, 347, 349, 353, 355, 361, 363, 371, 374
                    ];
                    return basicPokemon[Math.floor(Math.random() * basicPokemon.length)];
                },

                async hatchPokemonEgg(specificId = null, forceShiny = false) {
                    const id = specificId || this.getRandomBasicPokemonId();
                    const isShiny = forceShiny || (Math.random() < 0.01);

                    const pokemonData = await this.fetchPokemonFromAPI(id, isShiny);
                    if (!pokemonData) return;

                    this.pokemonState = {
                        exists: true,
                        isEgg: false,
                        species: pokemonData,
                        level: 1,
                        xp: 0,
                        maxXp: 100,
                        streak: 0,
                        totalAttempts: 0,
                        successfulAttempts: 0,
                        moves: [pokemonData.moves[0]],
                        evolutionStage: 0,
                        stats: this.calculatePokemonStats(pokemonData.baseStats, 1),
                        nickname: null,
                        hatchedAt: new Date().toISOString(),
                        lastLevelUp: new Date().toISOString(),
                        energy: 100,
                        maxEnergy: 100
                    };

                    this.saveGameState();
                    this.log(`Hatched ${pokemonData.name} (ID: ${id}, Shiny: ${isShiny})`);
                    this.triggerConfetti();

                    // Check initial evolution status (unlikely but good practice)
                    this.checkEvolutionAvailability();
                },

                calculatePokemonStats(baseStats, level) {
                    const multiplier = 1 + (level * 0.05);
                    return {
                        hp: Math.floor(baseStats.hp * multiplier),
                        attack: Math.floor(baseStats.attack * multiplier),
                        defense: Math.floor(baseStats.defense * multiplier),
                        speed: Math.floor(baseStats.speed * multiplier)
                    };
                },

                // ==========================================
                // PROGRESSION LOGIC
                // ==========================================

                addXP(amount) {
                    if (!this.pokemonState.exists) return;
                    this.pokemonState.xp = (this.pokemonState.xp || 0) + amount;
                    this.log(`Added ${amount} XP. Total: ${this.pokemonState.xp}`);

                    const xpNeeded = this.pokemonState.level * 100;
                    if (this.pokemonState.xp >= xpNeeded) {
                        this.pokemonState.xp -= xpNeeded;
                        this.levelUpPokemon();
                    } else {
                        this.saveGameState();
                    }
                },

                forceLevelUp() {
                    if (!this.pokemonState.exists) return;
                    this.levelUpPokemon();
                },

                levelUpPokemon() {
                    this.pokemonState.level++;
                    this.pokemonState.stats = this.calculatePokemonStats(
                        this.pokemonState.species.baseStats,
                        this.pokemonState.level
                    );

                    this.log(`LEVEL UP! Now Level ${this.pokemonState.level}`);
                    this.saveGameState();
                    this.triggerConfetti();

                    // Check evolution
                    this.checkEvolutionAvailability();
                },

                // ==========================================
                // EVOLUTION LOGIC
                // ==========================================

                async checkEvolutionAvailability(itemUsed = null) {
                    if (!this.pokemonState.exists || !this.pokemonState.species.evolutionChainUrl) return;

                    this.log(`Checking evolution... (Item: ${itemUsed || 'None'})`);

                    try {
                        const response = await fetch(this.pokemonState.species.evolutionChainUrl);
                        const data = await response.json();

                        const findSpecies = (chain) => {
                            if (chain.species.name === this.pokemonState.species.name.toLowerCase()) {
                                return chain;
                            }
                            for (const evolution of chain.evolves_to) {
                                const found = findSpecies(evolution);
                                if (found) return found;
                            }
                            return null;
                        };

                        const currentChainLink = findSpecies(data.chain);

                        if (currentChainLink && currentChainLink.evolves_to.length > 0) {
                            const evolution = currentChainLink.evolves_to[0];
                            const details = evolution.evolution_details[0];

                            let canEvolveNow = false;

                            if (details.trigger.name === 'level-up') {
                                if (details.min_level && this.pokemonState.level >= details.min_level) {
                                    canEvolveNow = true;
                                } else if (!details.min_level) {
                                    // Fallback for happiness/other
                                    if (this.pokemonState.level >= 20) canEvolveNow = true;
                                }
                            }
                            else if (details.trigger.name === 'use-item' || itemUsed === 'evolution_stone') {
                                if (itemUsed === 'evolution_stone') canEvolveNow = true;
                            }
                            else if (details.trigger.name === 'trade' && itemUsed === 'evolution_stone') {
                                canEvolveNow = true;
                            }

                            if (canEvolveNow) {
                                this.canEvolve = true;
                                this.evolutionTarget = {
                                    name: evolution.species.name,
                                    url: evolution.species.url,
                                    id: evolution.species.url.split('/').slice(-2, -1)[0]
                                };
                                this.log(`Evolution Available: -> ${evolution.species.name}`);

                                if (itemUsed) {
                                    this.evolvePokemon();
                                }
                            } else {
                                this.log(`Cannot evolve yet. Needs: ${JSON.stringify(details)}`);
                            }
                        } else {
                            this.log("No further evolutions found.");
                        }
                    } catch (error) {
                        this.log(`Error checking evolution: ${error.message}`);
                    }
                },

                async evolvePokemon() {
                    if (!this.evolutionTarget) return;
                    this.log(`Evolving to ${this.evolutionTarget.name}...`);

                    const oldSprite = this.pokemonState.species.sprite;
                    const newPokemonData = await this.fetchPokemonFromAPI(this.evolutionTarget.id, this.pokemonState.species.isShiny);

                    if (newPokemonData) {
                        this.pokemonAnimationData = {
                            oldSprite: oldSprite,
                            newSprite: newPokemonData.sprite,
                            newName: newPokemonData.name
                        };

                        this.showPokemonAnimation = 'evolution';

                        this.pokemonState.species = newPokemonData;
                        this.pokemonState.evolutionStage++;
                        this.pokemonState.stats = this.calculatePokemonStats(newPokemonData.baseStats, this.pokemonState.level);

                        this.canEvolve = false;
                        this.evolutionTarget = null;

                        this.saveGameState();
                        this.triggerConfetti();
                        this.log("Evolution Successful!");
                    }
                },

                // ==========================================
                // ADMIN ACTIONS
                // ==========================================

                forceHatchId() {
                    if (this.forceId) {
                        this.hatchPokemonEgg(this.forceId);
                    }
                },

                forceShinyHatch() {
                    this.hatchPokemonEgg(null, true);
                },

                earnCoins(amount) {
                    this.economy.pokeCoins += amount;
                    this.economy.totalEarned += amount;
                    this.log(`Added ${amount} Coins.`);
                    this.saveGameState();
                },

                unlockAllLevels() {
                    // Unlock levels 1 to 25
                    this.completedLevels = Array.from({ length: 25 }, (_, i) => i + 1);
                    this.log("Unlocked all 25 levels.");
                    this.saveGameState();
                },

                resetAll() {
                    if (confirm("Are you sure you want to wipe all progress?")) {
                        localStorage.removeItem('sqlWorkshopPokemon');
                        localStorage.removeItem('sqlWorkshop_gameState');
                        location.reload();
                    }
                },

                // ==========================================
                // STORAGE
                // ==========================================

                saveGameState() {
                    // Save to BOTH keys to ensure compatibility
                    localStorage.setItem('sqlWorkshopPokemon', JSON.stringify(this.pokemonState));

                    const gameState = {
                        version: '2.0',
                        pokemonState: this.pokemonState,
                        economy: this.economy,
                        completedLevels: this.completedLevels,
                        achievements: {} // Not tracking achievements in admin
                    };
                    localStorage.setItem('sqlWorkshop_gameState', JSON.stringify(gameState));
                },

                loadGameState() {
                    const saved = localStorage.getItem('sqlWorkshop_gameState');
                    if (saved) {
                        try {
                            const gameState = JSON.parse(saved);
                            if (gameState.pokemonState) Object.assign(this.pokemonState, gameState.pokemonState);
                            if (gameState.economy) Object.assign(this.economy, gameState.economy);
                            if (gameState.completedLevels) this.completedLevels = gameState.completedLevels;
                            this.log("Game State Loaded.");
                        } catch (e) {
                            this.log("Error loading state.");
                        }
                    }

                    // Check evolution on load
                    if (this.pokemonState.exists) {
                        this.checkEvolutionAvailability();
                    }
                },

                triggerConfetti() {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            },
            mounted() {
                this.loadGameState();
                this.log("Admin Playground Initialized.");
            }
        }).mount('#app')
    </script>
</body>

</html>